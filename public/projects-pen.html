<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projects — antn.studio</title>

  <link href="https://fonts.cdnfonts.com/css/thegoodmonolith" rel="stylesheet" />
  <link href="https://fonts.cdnfonts.com/css/pp-neue-montreal" rel="stylesheet" />

  <style>
    :root{
      --spacing-base: 1rem;
      --color-text: #fff;
      --font-size-base: 14px;
      --border-radius: 10px;
      --hover-scale: 1.05;

      /* Vignette page */
      --page-vignette-size: 180px;
      --page-vignette-color: rgba(0,0,0,.85);
      --page-vignette-strong-size: 90px;
      --page-vignette-strong-color: rgba(0,0,0,.92);
      --page-vignette-extreme-size: 36px;
      --page-vignette-extreme-color: rgba(0,0,0,1);

      /* Matrice fixe (fond) */
      --m-bg: #0b0b0b;
      --m-dot-color: rgba(255,255,255,.08);
      --m-dot-size: 1.1px;
      --m-dot-space: 22px;

      /* Effets */
      --halo-color: rgba(255,255,255,0.25);
    }

    *{margin:0;padding:0;box-sizing:border-box;user-select:none}

    body{
      font-family:"PP Neue Montreal",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:#fff; overflow:hidden; position:relative;
      background-color: var(--m-bg);
      background-image:
        radial-gradient(circle, var(--m-dot-color) var(--m-dot-size), transparent calc(var(--m-dot-size) + 0.01px));
      background-size: var(--m-dot-space) var(--m-dot-space);
      background-position: 0 0;
      background-attachment: fixed;
    }

    /* Grain léger */
    body::before{
      content:""; position:fixed; inset:-50%;
      background:url("https://assets.iceable.com/img/noise-transparent.png") repeat 0 0/300px 300px;
      animation:noise .3s steps(5) infinite; opacity:.22; pointer-events:none; z-index:100;
    }
    @keyframes noise{
      0%{transform:translate(0,0)}
      50%{transform:translate(-2%,-3%)}
      100%{transform:translate(1%,0)}
    }

    a{position:relative;color:var(--color-text);text-decoration:none;font-weight:700;font-size:var(--font-size-base)}
    a::after{content:"";position:absolute;inset:0 0 0 auto;width:0;background:var(--color-text);z-index:-1;transition:width .3s cubic-bezier(.34,1.56,.64,1)}
    a:hover{color:#000;mix-blend-mode:difference}
    a:hover::after{width:100%}
    p{font-size:14px;font-weight:600;letter-spacing:-.01em}

    /* ===== Header / Footer ===== */
    .header,.footer{
      position:absolute; left:0; width:100vw; padding:1.2rem; z-index:10000;
      display:grid; grid-template-columns:repeat(12,1fr); column-gap:var(--spacing-base)
    }
    .header{top:0}
    .footer{bottom:0}

    /* On neutralise les styles “bulle” côté header uniquement */
    .header, .header *{
      background: transparent;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border: 0;
    }

    /* === YEARS (menu) === */
    .legacy-year-menu{grid-column:1 / span 4; position:relative;}
    .legacy-years-toggle{
      display:inline-flex; align-items:center; gap:.55rem;
      font-weight:800; font-size:13px; letter-spacing:.06em; text-transform:uppercase;
      color:#e9e9e9; cursor:pointer; padding:.4rem .6rem .4rem .2rem;
      border-radius:999px; user-select:none; position:relative;
    }
    .legacy-years-toggle::before{
      content:""; width:6px; height:6px; border-radius:50%;
      background:#e9e9e9; opacity:.9; display:inline-block; animation: blink 2.4s ease-in-out infinite;
    }
    @keyframes blink{0%,90%,100%{opacity:.9}45%{opacity:.3}}
    .chev{width:8px;height:8px;border-right:2px solid #e9e9e9;border-bottom:2px solid #e9e9e9;transform:rotate(45deg); transition:transform .2s ease; margin-left:.2rem;}
    .legacy-year-menu.open .chev{ transform:rotate(-135deg); }

    .legacy-years-panel{
      position:absolute; left:0; top:2.6rem; z-index:10001;
      display:flex; flex-direction:column; gap:.35rem;
      overflow:hidden;
      max-height:0; padding:0; opacity:0; transform:translateY(-4px); pointer-events:none;
      transition: max-height .35s ease, padding .2s ease, opacity .2s ease, transform .2s ease;
    }
    .legacy-year-menu.open .legacy-years-panel{
      max-height:50vh; padding:.45rem .4rem .55rem .4rem; opacity:1; transform:none; pointer-events:auto;
    }
    .legacy-years-panel::before{
      content:""; position:absolute; inset:-.2rem -1rem -.6rem -1rem; border-radius:8px;
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      background: rgba(0,0,0,.06); z-index:-1; opacity:0; transition: opacity .2s ease;
    }
    .legacy-year-menu.open .legacy-years-panel::before{ opacity:1; }

    .years{ display:flex; flex-direction:column; gap:.35rem; }
    .year-btn{
      all:unset; cursor:pointer; color:#bcbcbc; font-weight:700; letter-spacing:-.01em;
      padding:.22rem .55rem; border-radius:6px; transition:color .2s ease, background .2s ease; display:block;
    }
    .year-btn:hover{ color:#fff; background:rgba(255,255,255,0.05);}
    .year-btn[aria-pressed="true"]{ color:#fff; background:rgba(255,255,255,0.08);}

    .years-close{
      all:unset; cursor:pointer; align-self:flex-start; margin-top:.25rem;
      color:#ddd; font-weight:800; font-size:10px; letter-spacing:.14em; text-transform:uppercase;
      opacity:.8; padding:.2rem .5rem;
    }
    .years-close:hover{ opacity:1; }

    /* Footer */
    .coordinates-section{grid-column:1 / span 4;font-family:"TheGoodMonolith",monospace}
    .links-section{grid-column:5 / span 4;display:flex;justify-content:center;gap:1rem}
    .info-section{grid-column:9 / span 4;text-align:right;font-family:"TheGoodMonolith",monospace}

    /* ===== Canvas / grid ===== */
    .container{position:relative;width:100vw;height:100vh;overflow:hidden;cursor:grab; z-index:1;}
    .canvas{position:absolute;will-change:transform}

    .item{position:absolute;overflow:hidden;background:#000;cursor:pointer;border-radius:var(--border-radius)}
    .item-image-container{position:relative;width:100%;height:100%;overflow:hidden;border-radius:inherit}
    .item-image-container::before{content:"";position:absolute;inset:0;background: radial-gradient(circle at center, transparent 55%, var(--halo-color) 130%);opacity:0;transition:opacity .35s ease}
    .item img{width:100%;height:100%;object-fit:cover;pointer-events:none;transition:transform .3s ease, filter .45s ease;filter: grayscale(100%) contrast(1.1) brightness(0.82)}
    .item:hover img{transform:scale(var(--hover-scale)); filter:none}
    .item:hover .item-image-container::before{opacity:.8}

    .item-caption{position:absolute;left:0;bottom:0;width:100%;padding:10px;z-index:2;background:linear-gradient(to top, rgba(0,0,0,.7), transparent)}
    .item-name{font-size:12px;text-transform:uppercase;letter-spacing:-.03em;margin-bottom:2px;overflow:hidden;height:16px}
    .item-number{font:400 10px/1 "TheGoodMonolith",monospace;color:#888;overflow:hidden;height:14px}

    /* Styles restants non utilisés pour overlay local (laissé inoffensif) */
    .expanded-item{display:none}
    .overlay{display:none}

    .page-vignette-container{position:fixed;inset:0;pointer-events:none;z-index:9998}
    .page-vignette{position:absolute;inset:0;box-shadow:inset 0 0 var(--page-vignette-size) var(--page-vignette-color)}
    .page-vignette-strong{position:absolute;inset:0;box-shadow:inset 0 0 var(--page-vignette-strong-size) var(--page-vignette-strong-color)}
    .page-vignette-extreme{position:absolute;inset:0;box-shadow:inset 0 0 var(--page-vignette-extreme-size) var(--page-vignette-extreme-color)}

    .project-title{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;z-index:10002}
    .project-title p{position:relative;height:42px}
    .project-title p .word{display:inline-block;font-size:36px;letter-spacing:-.03em;text-transform:uppercase}

    .links-section a{font-weight:700;font-size:13px}
  </style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="legacy-year-menu" id="legacyYears">
      <div class="legacy-years-toggle" id="legacyYearsToggle" role="button" aria-expanded="false" aria-controls="legacyYearsPanel">
        <span>+ YEARS</span>
        <span class="chev" aria-hidden="true"></span>
      </div>
      <div class="legacy-years-panel" id="legacyYearsPanel">
        <div class="years" id="years"></div>
        <button class="years-close" id="legacyYearsClose">Close</button>
      </div>
    </div>
  </div>

  <!-- ===== FOOTER ===== -->
  <div class="footer">
    <div class="coordinates-section"><p>48.7264° N, 2.2770° E</p></div>
    <div class="links-section" id="socials"></div>
    <div class="info-section"><p>Est. 2025 • antn.studio</p></div>
  </div>

  <!-- ===== GRID ===== -->
  <div class="container">
    <div class="canvas" id="canvas"></div>
  </div>

  <div class="project-title"><p></p></div>

  <div class="page-vignette-container">
    <div class="page-vignette"></div>
    <div class="page-vignette-strong"></div>
    <div class="page-vignette-extreme"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/CustomEase.min.js"></script>
  <script src="https://unpkg.com/split-type"></script>

  <script>
  (function(){
    const { gsap, CustomEase, SplitType } = window;
    gsap.registerPlugin(CustomEase);
    CustomEase.create("hop","0.9,0,0.1,1");

    /* ===== Data ===== */
    let PROJECTS = []; // { id, title, year, image, poster?, embed?, src?, videoSrc?, link? }
    let HAS_PARENT_DATA = false;
    let REQUESTED_PARENT = false;

    // parsing année depuis le titre
    function yearFromTitle(t){
      if(!t || typeof t !== "string") return null;
      const m = t.match(/(?:^|\D)(20\d{2}|19\d{2})(?:\D|$)/);
      const y = m ? parseInt(m[1],10) : null;
      if(y && y>=1900 && y<=2100) return y;
      return null;
    }

    // --- PATCH: on préserve les champs vidéo & poster ---
    function pickPoster(it){
      return (
        it.poster ||
        it.thumbnail ||
        (it.pictures && it.pictures.sizes && it.pictures.sizes.length
          ? it.pictures.sizes[it.pictures.sizes.length - 1].link
          : null) ||
        it.picture ||
        it.thumb ||
        ""
      );
    }

    function normalize(list){
      return (Array.isArray(list) ? list : []).map(it => {
        const title = it.title || it.name || "Untitled";
        const yFromTitle = yearFromTitle(title);
        const created = it.createdAt || it.created_time || null;
        const yFromDate = created ? new Date(created).getFullYear() : (it.year || null);

        return {
          id: String(it.id ?? (it.uri && it.uri.split("/").pop()) ?? title),
          title,
          year: yFromTitle ?? yFromDate ?? new Date().getFullYear(),
          image: pickPoster(it),

          // champs conservés pour le parent
          poster: pickPoster(it),
          embed: it.embed || (it.player && it.player.embed_url) || null,
          src: it.src || null,
          videoSrc: it.videoSrc || null,
          link: it.link || null,
        };
      });
    }

    async function loadProjects(){
      if (HAS_PARENT_DATA) return;
      try{
        const res = await fetch("/api/vimeo", { cache:"no-store" });
        const json = await res.json();
        const items = normalize(json?.items);
        PROJECTS = items.filter(p => !!p.image);
      }catch(e){
        PROJECTS = [];
      }
    }

    const SOCIALS = [
      { label: "Instagram", href: "https://www.instagram.com/antnstudio/" },
      { label: "X / Twitter", href: "https://x.com/antnstudio" },
      { label: "LinkedIn", href: "https://www.linkedin.com/in/antnstudio/" },
    ];

    const settings = {
      baseWidth: 400, smallHeight: 330, largeHeight: 500, itemGap: 65,
      hoverScale: 1.05, dragEase: 0.075, momentumFactor: 200,
      bufferZone: 3
    };

    /* ===== DOM ===== */
    const container = document.querySelector(".container");
    const canvas = document.getElementById("canvas");
    const projectTitleElement = document.querySelector(".project-title p");

    const yearsWrap   = document.getElementById("legacyYears");
    const yearsToggle = document.getElementById("legacyYearsToggle");
    const yearsClose  = document.getElementById("legacyYearsClose");
    const yearsEl     = document.getElementById("years");
    const socialsEl   = document.getElementById("socials");

    /* Socials */
    SOCIALS.forEach(s => {
      const a = document.createElement("a");
      a.href = s.href; a.target = "_blank"; a.rel = "noreferrer";
      a.textContent = s.label;
      socialsEl.appendChild(a);
    });

    /* ===== Years ===== */
    let uniqueYears = [];
    const qpYear = new URLSearchParams(location.search).get("year");
    let activeYear = "All";

    function buildYearsFromProjects(){
      uniqueYears = Array.from(new Set(PROJECTS.map(p => p.year))).sort((a,b)=>b-a);
      activeYear = qpYear ? (qpYear === "all" ? "All" : String(qpYear)) : "All";
    }

    function renderYears(){
      yearsEl.innerHTML = "";
      yearsEl.appendChild(makeYearBtn("All"));
      uniqueYears.forEach(y => yearsEl.appendChild(makeYearBtn(String(y))));
      updateYearButtons();
    }
    function makeYearBtn(label){
      const b = document.createElement("button");
      b.className = "year-btn";
      b.textContent = label;
      b.addEventListener("click", ()=>{ setActiveYear(label); closeYears(); });
      return b;
    }
    function updateYearButtons(){
      yearsEl.querySelectorAll(".year-btn").forEach(btn=>{
        btn.setAttribute("aria-pressed", String(btn.textContent === String(activeYear)));
      });
    }
    function setActiveYear(label){
      activeYear = label;
      document.documentElement.setAttribute("data-year", String(label).toLowerCase());
      resetAndRebuild();
      updateYearButtons();
      // PATCH: informer le parent du filtre en cours si besoin
      window.parent?.postMessage({ type: "REQUEST_YEAR_ACK", value: activeYear === "All" ? "all" : activeYear }, "*");
    }

    function openYears(){
      yearsWrap.classList.add("open");
      yearsToggle.setAttribute("aria-expanded","true");
    }
    function closeYears(){
      yearsWrap.classList.remove("open");
      yearsToggle.setAttribute("aria-expanded","false");
    }
    yearsToggle.addEventListener("click", ()=>{
      yearsWrap.classList.toggle("open");
      yearsToggle.setAttribute("aria-expanded", yearsWrap.classList.contains("open"));
    });
    yearsClose.addEventListener("click", closeYears);

    function currentList(){
      if(activeYear==="All") return PROJECTS;
      const y = parseInt(activeYear,10);
      return PROJECTS.filter(p => p.year === y);
    }

    /* ===== Grille / rendu infini ===== */
    const itemSizes = [
      { width: settings.baseWidth, height: settings.smallHeight },
      { width: settings.baseWidth, height: settings.largeHeight }
    ];
    const cellWidth = settings.baseWidth + 65;
    const cellHeight = Math.max(settings.smallHeight, settings.largeHeight) + 65;
    let columns = 4;

    let isDragging=false,startX,startY,targetX=0,targetY=0,currentX=0,currentY=0,dragVX=0,dragVY=0,lastDrag=0;
    let mouseHasMoved=false,visibleItems=new Set(),lastUpdate=0,lastX=0,lastY=0;

    function getItemSize(row,col){ const idx = Math.abs((row*columns+col)%itemSizes.length); return itemSizes[idx]; }
    function getItemId(col,row){ return `${col},${row}`; }
    function getItemPos(col,row){ return { x: col*cellWidth, y: row*cellHeight }; }

    function updateVisibleItems(){
      const list = currentList();
      const itemCount = list.length || 1;
      if(!itemCount) return;

      const buffer = 3;
      const vw = innerWidth*(1+buffer), vh = innerHeight*(1+buffer);
      const startCol = Math.floor((-currentX - vw/2)/cellWidth);
      const endCol   = Math.ceil((-currentX + vw*1.5)/cellWidth);
      const startRow = Math.floor((-currentY - vh/2)/cellHeight);
      const endRow   = Math.ceil((-currentY + vh*1.5)/cellHeight);

      const currentSet = new Set();

      for(let row=startRow; row<=endRow; row++){
        for(let col=startCol; col<=endCol; col++){
          const id = getItemId(col,row); currentSet.add(id);
          if(visibleItems.has(id)) continue;

          const size = getItemSize(row,col);
          const pos = getItemPos(col,row);
          const idx = Math.abs((row*columns+col) % itemCount);
          const proj = list[idx];

          const item = document.createElement("div");
          item.className="item"; item.id=id;
          item.style.width = `${size.width}px`;
          item.style.height = `${size.height}px`;
          item.style.left = `${pos.x}px`;
          item.style.top  = `${pos.y}px`;
          item.dataset.width = size.width;
          item.dataset.height = size.height;
          item.dataset.year = String(proj.year);

          const imageContainer = document.createElement("div");
          imageContainer.className = "item-image-container";
          const img = document.createElement("img");
          img.src = proj.image || "";
          img.alt = proj.title;
          imageContainer.appendChild(img); item.appendChild(imageContainer);

          const caption = document.createElement("div");
          caption.className = "item-caption";
          const name = document.createElement("div"); name.className="item-name"; name.textContent = proj.title;
          const number = document.createElement("div"); number.className="item-number"; number.textContent = String(proj.year);
          caption.appendChild(name); caption.appendChild(number); item.appendChild(caption);

          // PATCH: clic => notifie le parent d’ouvrir le player
          item.addEventListener("click", () => {
            if(mouseHasMoved||isDragging) return;
            const payload = {
              id: proj.id,
              title: proj.title,
              poster: proj.poster || proj.image,
              embed: proj.embed || proj.src || proj.videoSrc || null,
              link: proj.link || null,
              year: proj.year
            };
            window.parent?.postMessage({ type: "OPEN_PLAYER", value: payload }, "*");
          });

          canvas.appendChild(item); visibleItems.add(id);
        }
      }

      // cleanup
      visibleItems.forEach((id)=>{
        if(!currentSet.has(id)){
          const el = document.getElementById(id);
          if(el && el.parentNode===canvas) canvas.removeChild(el);
          visibleItems.delete(id);
        }
      });
    }

    function animate(){
      const e = settings.dragEase;
      currentX += (targetX-currentX)*e;
      currentY += (targetY-currentY)*e;
      canvas.style.transform = `translate(${currentX}px,${currentY}px)`;
      const now = Date.now(), dist = Math.hypot(currentX-lastX,currentY-lastY);
      if(dist>100 || now-lastUpdate>120){ updateVisibleItems(); lastX=currentX; lastY=currentY; lastUpdate=now; }
      requestAnimationFrame(animate);
    }

    // drag / touch
    container.addEventListener("mousedown",(e)=>{ isDragging=true; mouseHasMoved=false; startX=e.clientX; startY=e.clientY; container.style.cursor="grabbing"; });
    addEventListener("mousemove",(e)=>{ if(!isDragging) return; const dx=e.clientX-startX, dy=e.clientY-startY; if(Math.abs(dx)>5||Math.abs(dy)>5) mouseHasMoved=true; const now=Date.now(), dt=Math.max(10, now-lastDrag); lastDrag=now; dragVX=dx/dt; dragVY=dy/dt; targetX+=dx; targetY+=dy; startX=e.clientX; startY=e.clientY; });
    addEventListener("mouseup",()=>{ if(!isDragging) return; isDragging=false; container.style.cursor="grab"; if(Math.abs(dragVX)>0.1||Math.abs(dragVY)>0.1){ targetX += dragVX*settings.momentumFactor; targetY += dragVY*settings.momentumFactor; } });

    container.addEventListener("touchstart",(e)=>{ isDragging=true; mouseHasMoved=false; startX=e.touches[0].clientX; startY=e.touches[0].clientY; });
    addEventListener("touchmove",(e)=>{ if(!isDragging) return; const dx=e.touches[0].clientX-startX, dy=e.touches[0].clientY-startY; if(Math.abs(dx)>5||Math.abs(dy)>5) mouseHasMoved=true; targetX+=dx; targetY+=dy; startX=e.touches[0].clientX; startY=e.touches[0].clientY; });
    addEventListener("touchend",()=>{ isDragging=false; });

    addEventListener("resize",()=>{ updateVisibleItems(); });

    function resetAndRebuild(){
      const ids=[...visibleItems]; ids.forEach(id=>{ const el=document.getElementById(id); if(el&&el.parentNode===canvas) canvas.removeChild(el); });
      visibleItems.clear();
      currentX=currentY=targetX=targetY=lastX=lastY=0; canvas.style.transform="translate(0,0)";
      updateVisibleItems();
    }

    /* ====== Messaging avec le parent (Next.js) ====== */
    window.addEventListener("message", (evt) => {
      const data = evt && evt.data;
      if (!data || typeof data !== "object") return;

      if (data.type === "SET_STATUS") {
        let badge = document.getElementById("apiStatusBadge");
        if (!badge) {
          badge = document.createElement("div");
          badge.id = "apiStatusBadge";
          Object.assign(badge.style, {
            position: "fixed",
            right: "10px",
            bottom: "10px",
            font: "600 11px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif",
            color: "#bbb",
            background: "rgba(0,0,0,.35)",
            padding: "6px 8px",
            borderRadius: "8px",
            zIndex: 10050,
            pointerEvents: "none",
          });
          document.body.appendChild(badge);
        }
        const ok = data.value?.ok;
        const count = data.value?.count ?? 0;
        badge.textContent = ok ? `Vimeo OK • ${count} items` : `Vimeo KO`;
      }

      if (data.type === "SET_PROJECTS") {
        HAS_PARENT_DATA = true;
        PROJECTS = normalize(data.value).filter(p => !!p.image);
        buildYearsFromProjects();
        renderYears();
        setActiveYear(activeYear);
      }

      if (data.type === "SET_YEAR") {
        const value = data.value;
        document.documentElement.setAttribute("data-year-controlled", "true");
        setActiveYear(value === "all" ? "All" : String(value));
        openYears();
      }

      // Optionnel : le parent peut demander explicitement les projets/année
      if (data.type === "PING") {
        window.parent?.postMessage({ type: "PONG" }, "*");
      }
    });

    /* ===== Init ===== */
    (async function init(){
      // Signaler au parent qu'on est prêt
      window.parent?.postMessage({ type: "IFRAME_READY" }, "*");

      await loadProjects();      // fetch Vimeo si le parent n'a pas injecté
      if (!HAS_PARENT_DATA && PROJECTS.length === 0 && !REQUESTED_PARENT) {
        REQUESTED_PARENT = true;
        window.parent?.postMessage({ type: "REQUEST_PROJECTS" }, "*");
        const y = new URLSearchParams(location.search).get("year");
        if (y) window.parent?.postMessage({ type: "REQUEST_YEAR" }, "*");
      }

      buildYearsFromProjects();
      renderYears();
      closeYears();
      setActiveYear(activeYear);
      updateVisibleItems();
      (function animateLoop(){ animate(); })();
    })();

    // Petite anim de titre (subtile)
    let titleSplit = null;
    function setAndAnimateTitle(title){
      if(!projectTitleElement) return;
      if(titleSplit) titleSplit.revert();
      projectTitleElement.textContent = title || "";
      titleSplit = new SplitType(projectTitleElement,{ types:"words" });
      gsap.set(titleSplit.words,{ y:"100%", opacity:0 });
      gsap.to(titleSplit.words,{ y:"0%", opacity:1, duration:0.8, stagger:.05, ease:"power3.out" });
    }
    // Met à jour le titre au scroll (facultatif)
    document.addEventListener("pointerup", ()=> {
      const list = currentList();
      if(list.length) setAndAnimateTitle(list[Math.floor(Math.random()*list.length)].title);
    });
  })();
  </script>
</body>
</html>
